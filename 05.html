<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome file</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__left">
    <div class="stackedit__toc">
      
<ul>
<li><a href="#contents">Contents</a></li>
<li><a href="#mindspore-basics">MindSpore Basics</a>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#procedure">Procedure</a></li>
</ul>
</li>
<li><a href="#mnist-handwritten-character-exercise">MNIST Handwritten Character Exercise</a>
<ul>
<li><a href="#introduction-1">Introduction</a></li>
<li><a href="#preparations">Preparations</a></li>
<li><a href="#detailed-design-and-implementation">Detailed Design and Implementation</a></li>
<li><a href="#procedure-1">Procedure</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
  <div class="stackedit__right">
    <div class="stackedit__html">
      <h1 id="contents">Contents</h1>
<ol>
<li>MindSpore Basics
<ol>
<li>Introduction
<ol>
<li>About This Exersie</li>
<li>Objectives</li>
<li>Lab Environment</li>
</ol>
</li>
<li>Procedure
<ol>
<li>Introduction to Tensors</li>
<li>Loading a Dataset</li>
<li>Building the Network</li>
<li>Training and Validating a Model</li>
<li>Auto Differentiation</li>
</ol>
</li>
</ol>
</li>
<li>MNIST Handwritten Character Exercise
<ol>
<li>Introduction</li>
<li>Preparations</li>
<li>Detailed Design and Implementation
<ol>
<li>Data Preparation</li>
<li>Procedure 392</li>
</ol>
</li>
</ol>
</li>
</ol>
<hr>
<h1 id="mindspore-basics">MindSpore Basics</h1>
<h2 id="introduction">Introduction</h2>
<h3 id="about-this-exersie">About This Exersie</h3>
<p>This exercise introduces the tensor data structure of MindSpore. By performing a series of operations on tensors, you can understand the basic syntax of MindSpore.</p>
<h3 id="objectives">Objectives</h3>
<ul>
<li>Master the method of creating tensors.</li>
<li>Master the properties and methods of tensors.</li>
</ul>
<h3 id="lab-environment">Lab Environment</h3>
<p>MindSpore 1.2 or later is recommended. The exercise can be performed on a PC or by logging in to HUAWEI CLOUD and purchasing the ModelArts service.</p>
<h2 id="procedure">Procedure</h2>
<h3 id="introduction-to-tensors">Introduction to Tensors</h3>
<p>Tensor is a basic data structure in the MindSpore network computing. For details about data types in tensors, see <code>dtype</code>.<br>
Tensors of different dimensions represent different data. For example, a 0-dimensional tensor represents a scalar, a 1-dimensional tensor represents a vector, a 2-dimensional tensor represents a matrix, and a 3-dimensional tensor may represent the three channels of RGB images.</p>
<p>MindSpore tensors support different data types, including int8, int16, int32, int64, uint8, uint16, uint32, uint64, float16, float32, float64 and bool, which correspond to the data types of NumPy.</p>
<p>In the computation process of MindSpore, the int data type in Python is converted into the defined int64 type, and the float data type is converted into the defined float32 type.</p>
<h4 id="creating-a-tensor">Creating a Tensor</h4>
<p>During tensor construction, the tensor, float, int, Boolean, tuple, list, and NumPy.array types can be input. The tuple and list can store only data of the float, int, and Boolean types.<br>
The data type can be specified during tensor initialization. However, if the data type is not specified, the initial int, float, and bool values respectively generate 0-dimensional tensors with mindspore.int32, mindspore.float32 and mindspore.bool_ data types. The data types of the 1-dimensional tensors generated by the initial values tuple and list correspond to those of tensors stored in the tuple and list. If multiple types of data are contained, the MindSpore data type corresponding to the type with the highest priority is selected (Boolean &lt; int &lt; float). If the initial value is Tensor, the data type is tensor. If the initial value is NumPy.array, the generated tensor data type corresponds to NumPy.array.</p>
<h5 id="create-a-tensor-using-an-array.">Create a tensor using an array.</h5>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Import MindSpore.</span>
<span class="token keyword">import</span> mindspore
<span class="token comment"># The cell outputs multiple lines at the same time.</span>
<span class="token keyword">from</span> IPython<span class="token punctuation">.</span>core<span class="token punctuation">.</span>interactiveshell <span class="token keyword">import</span> InteractiveShell
InteractiveShell<span class="token punctuation">.</span>ast_node_interactivity <span class="token operator">=</span> <span class="token string">"all"</span>

<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> mindspore <span class="token keyword">import</span> Tensor
<span class="token keyword">from</span> mindspore <span class="token keyword">import</span> dtype
<span class="token comment"># Use an array to create a tensor.</span>
x <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
x
</code></pre>
<p>Output:</p>
<pre><code>Tensor(shape=[2, 2], dtype=Int32, value=
[[1, 2],
 [3, 4]])
</code></pre>
<h5 id="create-tensors-using-numbers.">Create tensors using numbers.</h5>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Use numbers to create tensors.</span>
y <span class="token operator">=</span> Tensor<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> dtype<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
z <span class="token operator">=</span> Tensor<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> dtype<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>Tensor(shape=[], dtype=Int32, value= 1)
Tensor(shape=[], dtype=Int32, value= 2)
</code></pre>
<h5 id="create-a-tensor-using-boolean.">Create a tensor using Boolean.</h5>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Use Boolean to create a tensor.</span>
m <span class="token operator">=</span> Tensor<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> dtype<span class="token punctuation">.</span>bool_<span class="token punctuation">)</span>
m
</code></pre>
<p>Output:</p>
<pre><code>Tensor(shape=[], dtype=Bool, value= True)
</code></pre>
<h5 id="create-a-tensor-using-a-tuple.">Create a tensor using a tuple.</h5>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Use a tuple to create a tensor.</span>
n <span class="token operator">=</span> Tensor<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token punctuation">.</span>int16<span class="token punctuation">)</span>
n
</code></pre>
<p>Output:</p>
<pre><code>Tensor(shape=[3], dtype=Int16, value= [1, 2, 3])
</code></pre>
<h5 id="create-a-tensor-using-a-list.">Create a tensor using a list.</h5>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Use a list to create a tensor.</span>
p <span class="token operator">=</span> Tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">4.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">6.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token punctuation">.</span>float64<span class="token punctuation">)</span>
p
</code></pre>
<p>Output:</p>
<pre><code>Tensor(shape=[3], dtype=Float64, value= [4.00000000e+000, 5.00000000e+000, 6.00000000e+000]
</code></pre>
<h5 id="inherit-attributes-of-another-tensor-to-form-a-new-tensor.">Inherit attributes of another tensor to form a new tensor.</h5>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> mindspore <span class="token keyword">import</span> ops
oneslike <span class="token operator">=</span> ops<span class="token punctuation">.</span>OnesLike<span class="token punctuation">(</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span><span class="token punctuation">)</span>
output <span class="token operator">=</span> oneslike<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
output
</code></pre>
<p>Output:</p>
<pre><code>Tensor(shape=[2, 2], dtype=Int32, value=
[[1, 1],
 [1, 1]])
</code></pre>
<h5 id="output-constant-tensor-value.">Output constant tensor value.</h5>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> mindspore<span class="token punctuation">.</span>ops <span class="token keyword">import</span> operations <span class="token keyword">as</span> ops

shape <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
ones <span class="token operator">=</span> ops<span class="token punctuation">.</span>Ones<span class="token punctuation">(</span><span class="token punctuation">)</span>
output <span class="token operator">=</span> ones<span class="token punctuation">(</span>shape<span class="token punctuation">,</span>dtype<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>

zeros <span class="token operator">=</span> ops<span class="token punctuation">.</span>Zeros<span class="token punctuation">(</span><span class="token punctuation">)</span>
output <span class="token operator">=</span> zeros<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> dtype<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>[[1. 1.]
 [1. 1.]]
[[0. 0.]
 [0. 0.]]
</code></pre>
<h4 id="tensor-attributes">Tensor Attributes</h4>
<p>Tensor attributes include shape and data type (dtype).</p>
<ul>
<li>Shape: a tuple</li>
<li>Dtype: a data type of MindSpore</li>
</ul>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python">x <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>

x<span class="token punctuation">.</span>shape <span class="token comment"># Shape</span>
x<span class="token punctuation">.</span>dtype <span class="token comment"># Data type</span>
x<span class="token punctuation">.</span>ndim  <span class="token comment"># Dimension</span>
x<span class="token punctuation">.</span>size <span class="token comment"># Size</span>
</code></pre>
<p>Output:</p>
<pre><code>(2, 2)
mindspore.int32
2
4
</code></pre>
<h4 id="tensor-methods">Tensor Methods</h4>
<p><code>asnumpy()</code>: converts a tensor to an array of NumPy.</p>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python">y <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token punctuation">.</span>bool_<span class="token punctuation">)</span>

<span class="token comment"># Convert the tensor data type to NumPy.</span>
y_array <span class="token operator">=</span> y<span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span>

y
y_array
</code></pre>
<p>Output:</p>
<pre><code>Tensor(shape=[2, 2], dtype=Bool, value=
[[ True,  True],
 [False, False]])

array([[ True,  True],
       [False, False]])
</code></pre>
<h4 id="tensor-operations">Tensor Operations</h4>
<p>There are many operations between tensors, including arithmetic, linear algebra, matrix processing (transposing, indexing, and slicing), and sampling. The following describes several operations. The usage of tensor computation is similar to that of NumPy.</p>
<h5 id="perform-indexing-and-slicing.">Perform indexing and slicing.</h5>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python">tensor <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"First row: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>tensor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"First column: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>tensor<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Last column: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>tensor<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>First row: [0. 1.]
First column: [0. 2.]
Last column: [1. 3.]
</code></pre>
<h5 id="concatenate-tensors.">Concatenate tensors.</h5>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python">data1 <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
data2 <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
op <span class="token operator">=</span> ops<span class="token punctuation">.</span>Stack<span class="token punctuation">(</span><span class="token punctuation">)</span>
output <span class="token operator">=</span> op<span class="token punctuation">(</span><span class="token punctuation">[</span>data1<span class="token punctuation">,</span> data2<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>[[[0. 1.]
  [2. 3.]]

 [[4. 5.]
  [6. 7.]]]
</code></pre>
<h5 id="convert-to-numpy.">Convert to NumPy.</h5>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python">zeros <span class="token operator">=</span> ops<span class="token punctuation">.</span>Zeros<span class="token punctuation">(</span><span class="token punctuation">)</span>
output <span class="token operator">=</span> zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"output: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
n_output <span class="token operator">=</span> output<span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"n_output: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>n_output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>output: &lt;class 'mindspore.common.tensor.Tensor'&gt;
n_output: &lt;class 'numpy.ndarray'&gt;
</code></pre>
<h3 id="loading-a-dataset">Loading a Dataset</h3>
<p>MindSpore.dataset provides APIs to load and process datasets, such as MNIST, CIFAR-10, CIFAR-100, VOC, ImageNet, and CelebA.</p>
<h4 id="load-the-mnist-dataset.">Load the MNIST dataset.</h4>
<p>You are advised to download the MNIST dataset from <a href="http://yann.lecun.com/exdb/mnist/">http://yann.lecun.com/exdb/mnist/</a> and save the training and test files to the MNIST folder.</p>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> mindspore<span class="token punctuation">.</span>dataset <span class="token keyword">as</span> ds
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

dataset_dir <span class="token operator">=</span> <span class="token string">"./MNIST/train"</span>  <span class="token comment"># Path of the dataset</span>
<span class="token comment"># Read three images from the MNIST dataset.</span>
mnist_dataset <span class="token operator">=</span> ds<span class="token punctuation">.</span>MnistDataset<span class="token punctuation">(</span>dataset_dir<span class="token operator">=</span>dataset_dir<span class="token punctuation">,</span> num_samples<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment"># View the images and set the image sizes.</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
i <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment"># Print three subgraphs.</span>
<span class="token keyword">for</span> dic <span class="token keyword">in</span> mnist_dataset<span class="token punctuation">.</span>create_dict_iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>dic<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    i <span class="token operator">+=</span><span class="token number">1</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<h4 id="mnist-dataset-sample">MNIST dataset sample</h4>
<h5 id="customize-a-dataset.">Customize a dataset.</h5>
<p>For datasets that cannot be directly loaded by MindSpore, you can build a custom dataset class and use the GeneratorDataset API to customize data loading.<br>
Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">58</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">DatasetGenerator</span><span class="token punctuation">:</span>
<span class="token comment"># When a dataset object is instantiated, the __init__ function is called. You can perform operations such as data initialization.</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>label <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Define the __getitem__ function of the dataset class to support random access and obtain and return data in the dataset based on the specified index value.</span>
    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>label<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
<span class="token comment"># Define the __len__ function of the dataset class and return the number of samples in the dataset.</span>
    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
<span class="token comment"># After the dataset class is defined, the GeneratorDataset API can be used to load and access dataset samples in the user-defined mode.</span>
dataset_generator <span class="token operator">=</span> DatasetGenerator<span class="token punctuation">(</span><span class="token punctuation">)</span>
dataset <span class="token operator">=</span> ds<span class="token punctuation">.</span>GeneratorDataset<span class="token punctuation">(</span>dataset_generator<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token comment"># Use the create_dict_iterator method to obtain data.</span>
<span class="token keyword">for</span> data <span class="token keyword">in</span> dataset<span class="token punctuation">.</span>create_dict_iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>[0.36510558 0.45120592] [0.78888122]
[0.49606035 0.07562207] [0.38068183]
[0.57176158 0.28963401] [0.16271622]
[0.30880446 0.37487617] [0.54738768]
[0.81585667 0.96883469] [0.77994068]
</code></pre>
<h5 id="perform-data-augmentation.">Perform data augmentation.</h5>
<p>The dataset APIs provided by MindSpore support data processing methods, such as shuffle and batch. You only need to call the corresponding function API to quickly process data.<br>
In the following example, the datasets are shuffled, and then two samples form a batch.</p>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python">ds<span class="token punctuation">.</span>config<span class="token punctuation">.</span>set_seed<span class="token punctuation">(</span><span class="token number">58</span><span class="token punctuation">)</span>

<span class="token comment"># Shuffle the data sequence. buffer_size indicates the size of the shuffled buffer in the dataset.</span>
dataset <span class="token operator">=</span> dataset<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>buffer_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment"># Divide the dataset into batches. batch_size indicates the number of data records contained in each batch. Set this parameter to 2.</span>
dataset <span class="token operator">=</span> dataset<span class="token punctuation">.</span>batch<span class="token punctuation">(</span>batch_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> data <span class="token keyword">in</span> dataset<span class="token punctuation">.</span>create_dict_iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"data: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"label: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>data: [[0.36510558 0.45120592]
 [0.57176158 0.28963401]]
label: [[0.78888122]
 [0.16271622]]
data: [[0.30880446 0.37487617]
 [0.49606035 0.07562207]]
label: [[0.54738768]
 [0.38068183]]
data: [[0.81585667 0.96883469]]
label: [[0.77994068]]
</code></pre>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

<span class="token keyword">from</span> mindspore<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>vision <span class="token keyword">import</span> Inter
<span class="token keyword">import</span> mindspore<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>vision<span class="token punctuation">.</span>c_transforms <span class="token keyword">as</span> c_vision

DATA_DIR <span class="token operator">=</span> <span class="token string">'./MNIST/train'</span>
<span class="token comment"># Obtain six samples.</span>
mnist_dataset <span class="token operator">=</span> ds<span class="token punctuation">.</span>MnistDataset<span class="token punctuation">(</span>DATA_DIR<span class="token punctuation">,</span> num_samples<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token comment"># View the original image data.</span>
mnist_it <span class="token operator">=</span> mnist_dataset<span class="token punctuation">.</span>create_dict_iterator<span class="token punctuation">(</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>mnist_it<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span>plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>gray<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<h5 id="data-sample">Data sample</h5>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python">resize_op <span class="token operator">=</span> c_vision<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>Inter<span class="token punctuation">.</span>LINEAR<span class="token punctuation">)</span>
crop_op <span class="token operator">=</span> c_vision<span class="token punctuation">.</span>RandomCrop<span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">)</span>
transforms_list <span class="token operator">=</span> <span class="token punctuation">[</span>resize_op<span class="token punctuation">,</span> crop_op<span class="token punctuation">]</span>
mnist_dataset <span class="token operator">=</span> mnist_dataset<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>operations<span class="token operator">=</span>transforms_list<span class="token punctuation">,</span> input_columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
mnist_dataset <span class="token operator">=</span> mnist_dataset<span class="token punctuation">.</span>create_dict_iterator<span class="token punctuation">(</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>mnist_dataset<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span>plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>gray<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<p>Effect after data argumentation</p>
<h3 id="building-the-network">Building the Network</h3>
<p>MindSpore encapsulates APIs for building network layers in the nn module. Different types of neural network layers are built by calling these APIs.</p>
<ul>
<li>Build a fully-connected layer.</li>
</ul>
<h4 id="fully-connected-layer-mindspore.nn.dense">Fully-connected layer: `mindspore.nn.Dense</h4>
<ul>
<li><code>in_channels</code>: input channel</li>
<li><code>out_channels</code>: output channel</li>
<li><code>weight_init</code>: weight initialization. Default: ‘normal’.</li>
</ul>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> mindspore <span class="token keyword">as</span> ms
<span class="token keyword">import</span> mindspore<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">from</span> mindspore <span class="token keyword">import</span> Tensor
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token comment"># Construct the input tensor.</span>
input_a <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>input_a<span class="token punctuation">)</span>
<span class="token comment"># Construct a fully-connected network. Set both in_channels and out_channels to 3.</span>
net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> weight_init<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
output <span class="token operator">=</span> net<span class="token punctuation">(</span>input_a<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>[[1. 1. 1.]
 [2. 2. 2.]]
[[3. 3. 3.]
 [6. 6. 6.]]
</code></pre>
<h4 id="build-a-convolutional-layer.">Build a convolutional layer.</h4>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python">conv2d <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> has_bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> weight_init<span class="token operator">=</span><span class="token string">'normal'</span><span class="token punctuation">,</span> pad_mode<span class="token operator">=</span><span class="token string">'valid'</span><span class="token punctuation">)</span>
input_x <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>conv2d<span class="token punctuation">(</span>input_x<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
Output<span class="token punctuation">:</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span>

Build a ReLU layer<span class="token punctuation">.</span>
Code<span class="token punctuation">:</span>
relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>
input_x <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span>float16<span class="token punctuation">)</span>
output <span class="token operator">=</span> relu<span class="token punctuation">(</span>input_x<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>[0. 2. 0. 2. 0.]
</code></pre>
<h4 id="build-a-pooling-layer.">Build a pooling layer.</h4>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python">max_pool2d <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
input_x <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>max_pool2d<span class="token punctuation">(</span>input_x<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>(1, 6, 14, 14)
</code></pre>
<h4 id="build-a-flatten-layer.">Build a flatten layer.</h4>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python">flatten <span class="token operator">=</span> nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>
input_x <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
output <span class="token operator">=</span> flatten<span class="token punctuation">(</span>input_x<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>(1, 400)
</code></pre>
<h4 id="define-a-model-class-and-view-parameters.">Define a model class and view parameters.</h4>
<p>The Cell class of MindSpore is the base class for building all networks and the basic unit of a network. When a neural network is required, you need to inherit the Cell class and overwrite the <strong>init</strong> and construct methods.</p>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">LeNet5</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Cell<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    LeNet network structure
    """</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_class<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> num_channel<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>LeNet5<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># Define the required operation.</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>num_channel<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> pad_mode<span class="token operator">=</span><span class="token string">'valid'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> pad_mode<span class="token operator">=</span><span class="token string">'valid'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">,</span> num_class<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>max_pool2d <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>flatten <span class="token operator">=</span> nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">construct</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Use the defined operation to build a forward network.</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x
<span class="token comment"># Instantiate the model and use the parameters_and_names method to view the model parameters.</span>
modelle <span class="token operator">=</span> LeNet5<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> m <span class="token keyword">in</span> modelle<span class="token punctuation">.</span>parameters_and_names<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>('conv1.weight', Parameter (name=conv1.weight, shape=(6, 1, 5, 5), dtype=Float32, requires_grad=True))
('conv2.weight', Parameter (name=conv2.weight, shape=(16, 6, 5, 5), dtype=Float32, requires_grad=True))
('fc1.weight', Parameter (name=fc1.weight, shape=(120, 400), dtype=Float32, requires_grad=True))
('fc1.bias', Parameter (name=fc1.bias, shape=(120,), dtype=Float32, requires_grad=True))
('fc2.weight', Parameter (name=fc2.weight, shape=(84, 120), dtype=Float32, requires_grad=True))
('fc2.bias', Parameter (name=fc2.bias, shape=(84,), dtype=Float32, requires_grad=True))
('fc3.weight', Parameter (name=fc3.weight, shape=(10, 84), dtype=Float32, requires_grad=True))
('fc3.bias', Parameter (name=fc3.bias, shape=(10,), dtype=Float32, requires_grad=True))
</code></pre>
<h3 id="training-and-validating-a-model">Training and Validating a Model</h3>
<h4 id="use-loss-functions.">Use loss functions.</h4>
<p>A loss function is used to validate the difference between the predicted and actual values of a model. Here, the absolute error loss function L1Loss is used. mindspore.nn.loss also provides many other loss functions, such as SoftmaxCrossEntropyWithLogits, MSELoss, and SmoothL1Loss.</p>
<p>The output value and target value are provided to compute the loss value. The method is as follows:</p>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> mindspore<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">from</span> mindspore <span class="token keyword">import</span> Tensor
<span class="token keyword">import</span> mindspore<span class="token punctuation">.</span>dataset <span class="token keyword">as</span> ds
<span class="token keyword">import</span> mindspore <span class="token keyword">as</span> ms
loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>L1Loss<span class="token punctuation">(</span><span class="token punctuation">)</span>
output_data <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
target_data <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>loss<span class="token punctuation">(</span>output_data<span class="token punctuation">,</span> target_data<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>1.5
</code></pre>
<h4 id="use-an-optimizer.">Use an optimizer.</h4>
<p>Common deep learning optimization algorithms include SGD, Adam, Ftrl, lazyadam, Momentum, RMSprop, Lars, Proximal_ada_grad, and lamb.</p>
<h5 id="momentum-optimizer-mindspore.nn.momentum">Momentum optimizer: <code>mindspore.nn.Momentum</code></h5>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python">optim <span class="token operator">=</span> nn<span class="token punctuation">.</span>Momentum<span class="token punctuation">(</span>params<span class="token operator">=</span>modelle<span class="token punctuation">.</span>trainable_params<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> learning_rate<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="build-a-model.">Build a model.</h4>
<p><code>mindspore.Model(network, loss_fn, optimizer, metrics)</code></p>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> mindspore <span class="token keyword">import</span> Model

<span class="token comment"># Define a neural network.</span>
net <span class="token operator">=</span> LeNet5<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Define the loss function.</span>
loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>SoftmaxCrossEntropyWithLogits<span class="token punctuation">(</span>sparse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">'mean'</span><span class="token punctuation">)</span>
<span class="token comment"># Define the optimizer.</span>
optim <span class="token operator">=</span> nn<span class="token punctuation">.</span>Momentum<span class="token punctuation">(</span>params<span class="token operator">=</span>net<span class="token punctuation">.</span>trainable_params<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> learning_rate<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>
<span class="token comment"># Build a model.</span>
model <span class="token operator">=</span> Model<span class="token punctuation">(</span>network <span class="token operator">=</span> net<span class="token punctuation">,</span> loss_fn<span class="token operator">=</span>loss<span class="token punctuation">,</span> optimizer<span class="token operator">=</span>optim<span class="token punctuation">,</span> metrics<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'accuracy'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
Train the model<span class="token punctuation">.</span>
Code<span class="token punctuation">:</span>
<span class="token keyword">import</span> mindspore<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>c_transforms <span class="token keyword">as</span> C
<span class="token keyword">import</span> mindspore<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>vision<span class="token punctuation">.</span>c_transforms <span class="token keyword">as</span> CV
<span class="token keyword">from</span> mindspore<span class="token punctuation">.</span>train<span class="token punctuation">.</span>callback <span class="token keyword">import</span>  LossMonitor

DATA_DIR <span class="token operator">=</span> <span class="token string">'./MNIST/train'</span>
mnist_dataset <span class="token operator">=</span> ds<span class="token punctuation">.</span>MnistDataset<span class="token punctuation">(</span>DATA_DIR<span class="token punctuation">)</span>

resize_op <span class="token operator">=</span> CV<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rescale_op <span class="token operator">=</span> CV<span class="token punctuation">.</span>Rescale<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
hwc2chw_op <span class="token operator">=</span> CV<span class="token punctuation">.</span>HWC2CHW<span class="token punctuation">(</span><span class="token punctuation">)</span>

mnist_dataset  <span class="token operator">=</span> mnist_dataset <span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>input_columns<span class="token operator">=</span><span class="token string">"image"</span><span class="token punctuation">,</span> operations<span class="token operator">=</span><span class="token punctuation">[</span>rescale_op<span class="token punctuation">,</span>resize_op<span class="token punctuation">,</span> hwc2chw_op<span class="token punctuation">]</span><span class="token punctuation">)</span>
mnist_dataset  <span class="token operator">=</span> mnist_dataset <span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>input_columns<span class="token operator">=</span><span class="token string">"label"</span><span class="token punctuation">,</span> operations<span class="token operator">=</span>C<span class="token punctuation">.</span>TypeCast<span class="token punctuation">(</span>ms<span class="token punctuation">.</span>int32<span class="token punctuation">)</span><span class="token punctuation">)</span>
mnist_dataset <span class="token operator">=</span> mnist_dataset<span class="token punctuation">.</span>batch<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
loss_cb <span class="token operator">=</span> LossMonitor<span class="token punctuation">(</span>per_print_times<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token comment"># dataset is an input parameter, which indicates the training set, and epoch indicates the number of training epochs of the training set.</span>
model<span class="token punctuation">.</span>train<span class="token punctuation">(</span>epoch<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> train_dataset<span class="token operator">=</span>mnist_dataset<span class="token punctuation">,</span>callbacks<span class="token operator">=</span><span class="token punctuation">[</span>loss_cb<span class="token punctuation">]</span><span class="token punctuation">)</span>    
</code></pre>
<h4 id="validate-the-model.">Validate the model.</h4>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># dataset is an input parameter, which indicates the validation set.</span>
DATA_DIR <span class="token operator">=</span> <span class="token string">'./forward_mnist/MNIST/test'</span>
dataset <span class="token operator">=</span> ds<span class="token punctuation">.</span>MnistDataset<span class="token punctuation">(</span>DATA_DIR<span class="token punctuation">)</span>

resize_op <span class="token operator">=</span> CV<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rescale_op <span class="token operator">=</span> CV<span class="token punctuation">.</span>Rescale<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
hwc2chw_op <span class="token operator">=</span> CV<span class="token punctuation">.</span>HWC2CHW<span class="token punctuation">(</span><span class="token punctuation">)</span>

dataset  <span class="token operator">=</span> dataset <span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>input_columns<span class="token operator">=</span><span class="token string">"image"</span><span class="token punctuation">,</span> operations<span class="token operator">=</span><span class="token punctuation">[</span>rescale_op<span class="token punctuation">,</span>resize_op<span class="token punctuation">,</span> hwc2chw_op<span class="token punctuation">]</span><span class="token punctuation">)</span>
dataset  <span class="token operator">=</span> dataset <span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>input_columns<span class="token operator">=</span><span class="token string">"label"</span><span class="token punctuation">,</span> operations<span class="token operator">=</span>C<span class="token punctuation">.</span>TypeCast<span class="token punctuation">(</span>ms<span class="token punctuation">.</span>int32<span class="token punctuation">)</span><span class="token punctuation">)</span>
dataset <span class="token operator">=</span> dataset<span class="token punctuation">.</span>batch<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>valid_dataset<span class="token operator">=</span>dataset<span class="token punctuation">)</span> 
</code></pre>
<h3 id="auto-differentiation">Auto Differentiation</h3>
<p>Backward propagation is the commonly used algorithm for training neural networks. In this algorithm, parameters (model weights) are adjusted based on a gradient of a loss function for a given parameter.</p>
<p>The first-order derivative method of MindSpore is mindspore.ops.GradOperation (get_all=False, get_by_list=False, sens_param=False). When get_all is set to False, the first input derivative is computed. When get_all is set to True, all input derivatives are computed. When get_by_list is set to False, weight derivatives are not computed. When get_by_list is set to True, weight derivatives are computed. sens_param scales the output value of the network to change the final gradient.</p>
<p>The following uses the MatMul operator derivative for in-depth analysis.</p>
<h4 id="compute-the-first-order-derivative-of-the-input.">Compute the first-order derivative of the input.</h4>
<p>To compute the input derivative, you need to define a network requiring a derivative. The following uses a network f(x,y)=z∗x∗y formed by the MatMul operator as an example.</p>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> mindspore<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> mindspore<span class="token punctuation">.</span>ops <span class="token keyword">as</span> ops
<span class="token keyword">from</span> mindspore <span class="token keyword">import</span> Tensor
<span class="token keyword">from</span> mindspore <span class="token keyword">import</span> ParameterTuple<span class="token punctuation">,</span> Parameter
<span class="token keyword">from</span> mindspore <span class="token keyword">import</span> dtype <span class="token keyword">as</span> mstype

<span class="token keyword">class</span> <span class="token class-name">Net</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Cell<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Net<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>matmul <span class="token operator">=</span> ops<span class="token punctuation">.</span>MatMul<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>z <span class="token operator">=</span> Parameter<span class="token punctuation">(</span>Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'z'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">construct</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> x <span class="token operator">*</span> self<span class="token punctuation">.</span>z
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
        <span class="token keyword">return</span> out
<span class="token keyword">class</span> <span class="token class-name">GradNetWrtX</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Cell<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> net<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>GradNetWrtX<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>net <span class="token operator">=</span> net
        self<span class="token punctuation">.</span>grad_op <span class="token operator">=</span> ops<span class="token punctuation">.</span>GradOperation<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">construct</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        gradient_function <span class="token operator">=</span> self<span class="token punctuation">.</span>grad_op<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">)</span>
        <span class="token keyword">return</span> gradient_function<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
x <span class="token operator">=</span> Tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1.8</span><span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">,</span> <span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>mstype<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
y <span class="token operator">=</span> Tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.11</span><span class="token punctuation">,</span> <span class="token number">3.3</span><span class="token punctuation">,</span> <span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1.4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>mstype<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
output <span class="token operator">=</span> GradNetWrtX<span class="token punctuation">(</span>Net<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>[[4.5099998 2.7       3.6000001]
 [4.5099998 2.7       3.6000001]]
</code></pre>
<h4 id="compute-the-first-order-derivative-of-the-weight.">Compute the first-order derivative of the weight.</h4>
<p>To compute weight derivatives, you need to set get_by_list in ops.GradOperation to True. If computation of certain weight derivatives is not required, set requirements_grad to False when defining the network requiring derivatives.</p>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">GradNetWrtX</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Cell<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> net<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>GradNetWrtX<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>net <span class="token operator">=</span> net
        self<span class="token punctuation">.</span>params <span class="token operator">=</span> ParameterTuple<span class="token punctuation">(</span>net<span class="token punctuation">.</span>trainable_params<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>grad_op <span class="token operator">=</span> ops<span class="token punctuation">.</span>GradOperation<span class="token punctuation">(</span>get_by_list<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">construct</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        gradient_function <span class="token operator">=</span> self<span class="token punctuation">.</span>grad_op<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">,</span> self<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
        <span class="token keyword">return</span> gradient_function<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
output <span class="token operator">=</span> GradNetWrtX<span class="token punctuation">(</span>Net<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>(Tensor(shape=[1], dtype=Float32, value= [ 2.15359993e+01]),)
</code></pre>
<hr>
<h1 id="mnist-handwritten-character-exercise">MNIST Handwritten Character Exercise</h1>
<h2 id="introduction-1">Introduction</h2>
<p>This exercise implements the MNIST handwritten character recognition, which is a typical case in the deep learning field. The whole process is as follows:</p>
<ul>
<li>Process the required dataset. The MNIST dataset is used in this example.</li>
<li>Define a network. A simple fully-connected network is built in this example.</li>
<li>Define a loss function and an optimizer.</li>
<li>Load the dataset and perform training. After the training is complete, use the test set for validation.</li>
</ul>
<h2 id="preparations">Preparations</h2>
<p>Before you start, check whether MindSpore has been correctly installed. You are advised to install MindSpore 1.1.1 or later on your computer by referring to the MindSpore official website <a href="https://www.mindspore.cn/install/">https://www.mindspore.cn/install/</a>.</p>
<p>In addition, you shall have basic mathematical knowledge such as Python coding basics, probability, and matrix.</p>
<h2 id="detailed-design-and-implementation">Detailed Design and Implementation</h2>
<h3 id="data-preparation">Data Preparation</h3>
<p>The MNIST dataset used in this example consists of 10 classes of 28 x 28 pixels grayscale images. It has a training set of 60,000 examples, and a test set of 10,000 examples.</p>
<p>Download the MNIST dataset at <a href="http://yann.lecun.com/exdb/mnist/">http://yann.lecun.com/exdb/mnist/</a>. Four dataset download links are provided. The first two links are for downloading test data files, and the last two links are for downloading training data files.</p>
<p>Download and decompress the files, and store them in the workspace directories ./MNIST /train and ./MNIST /test.</p>
<p>The directory structure is as follows:</p>
<pre><code>└─MNIST
    ├─  test
    │      t10k-images.idx3-ubyte
    │      t10k-labels.idx1-ubyte
    │
    └─  train
            train-images.idx3-ubyte
            train-labels.idx1-ubyte
</code></pre>
<h2 id="procedure-1">Procedure</h2>
<h3 id="import-the-python-library-and-module-and-configure-running-information.">Import the Python library and module and configure running information.</h3>
<h4 id="import-the-required-python-library.">Import the required Python library.</h4>
<p>Currently, the os library is required. Other required libraries will not be described here. For details about the MindSpore modules, see the MindSpore API page. You can use context.set_context to configure the information required for running, such as the running mode, backend information, and hardware information.</p>
<h4 id="import-the-context-module-and-configure-the-required-information.">Import the context module and configure the required information.</h4>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Import related dependent libraries.</span>
<span class="token keyword">import</span>  os
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">import</span> mindspore <span class="token keyword">as</span> ms
<span class="token keyword">import</span> mindspore<span class="token punctuation">.</span>context <span class="token keyword">as</span> context
<span class="token keyword">import</span> mindspore<span class="token punctuation">.</span>dataset <span class="token keyword">as</span> ds
<span class="token keyword">import</span> mindspore<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>c_transforms <span class="token keyword">as</span> C
<span class="token keyword">import</span> mindspore<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>vision<span class="token punctuation">.</span>c_transforms <span class="token keyword">as</span> CV
<span class="token keyword">from</span> mindspore<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> Accuracy

<span class="token keyword">from</span> mindspore <span class="token keyword">import</span> nn
<span class="token keyword">from</span> mindspore<span class="token punctuation">.</span>train <span class="token keyword">import</span> Model
<span class="token keyword">from</span> mindspore<span class="token punctuation">.</span>train<span class="token punctuation">.</span>callback <span class="token keyword">import</span> ModelCheckpoint<span class="token punctuation">,</span> CheckpointConfig<span class="token punctuation">,</span> LossMonitor<span class="token punctuation">,</span> TimeMonitor

context<span class="token punctuation">.</span>set_context<span class="token punctuation">(</span>mode<span class="token operator">=</span>context<span class="token punctuation">.</span>GRAPH_MODE<span class="token punctuation">,</span> device_target<span class="token operator">=</span><span class="token string">'CPU'</span><span class="token punctuation">)</span>
</code></pre>
<p>The graph mode is used in this exercise. You can configure hardware information as required. For example, if the code runs on the Ascend AI processor, set device_target to Ascend. This rule also applies to the code running on the CPU and GPU. For details about parameters, see the API description of context.set_context.</p>
<h4 id="read-data.">Read data.</h4>
<p>Use the data reading function of MindSpore to read the MNIST dataset and view the data volume and sample information of the training set and test set.</p>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python">DATA_DIR_TRAIN <span class="token operator">=</span> <span class="token string">"MNIST/train"</span> <span class="token comment"># Training set information</span>
DATA_DIR_TEST <span class="token operator">=</span> <span class="token string">"MNIST/test"</span> <span class="token comment"># Test set information</span>
<span class="token comment"># Read data.</span>
ds_train <span class="token operator">=</span> ds<span class="token punctuation">.</span>MnistDataset<span class="token punctuation">(</span>DATA_DIR_TRAIN<span class="token punctuation">)</span>
ds_test <span class="token operator">=</span> ds<span class="token punctuation">.</span>MnistDataset<span class="token punctuation">(</span>DATA_DIR_TEST <span class="token punctuation">)</span> 
<span class="token comment"># Display the dataset features.</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Data volume of the training dataset:'</span><span class="token punctuation">,</span>ds_train<span class="token punctuation">.</span>get_dataset_size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">' Data volume of the test dataset:'</span><span class="token punctuation">,</span>ds_test<span class="token punctuation">.</span>get_dataset_size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
image<span class="token operator">=</span>ds_train<span class="token punctuation">.</span>create_dict_iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__next__<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Image length/width/channels:'</span><span class="token punctuation">,</span>image<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Image label style:'</span><span class="token punctuation">,</span>image<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># Total 10 label classes which are represented by numbers from 0 to 9.</span>
</code></pre>
<h4 id="process-data.">Process data.</h4>
<p>Datasets are crucial for training. A good dataset can effectively improve training accuracy and efficiency. Generally, before loading a dataset, you need to perform some operations on the dataset.</p>
<ul>
<li>Define a dataset and data operations.
<ul>
<li>We define the create_dataset function to create a dataset. In this function, we define the data augmentation and processing operations to be performed:</li>
</ul>
</li>
<li>Read the dataset.</li>
<li>Define parameters required for data augmentation and processing.</li>
<li>Generate corresponding data augmentation operations according to the parameters.</li>
<li>Use the map function to apply data operations to the dataset.</li>
<li>Process the generated dataset.</li>
</ul>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">create_dataset</span><span class="token punctuation">(</span>training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> resize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   rescale<span class="token operator">=</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span> shift<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> buffer_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ds <span class="token operator">=</span> ms<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>MnistDataset<span class="token punctuation">(</span>DATA_DIR_TRAIN <span class="token keyword">if</span> training <span class="token keyword">else</span> DATA_DIR_TEST<span class="token punctuation">)</span>
    <span class="token comment"># Define the resizing, normalization, and channel conversion of the map operation.</span>
    resize_op <span class="token operator">=</span> CV<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span>resize<span class="token punctuation">)</span>
    rescale_op <span class="token operator">=</span> CV<span class="token punctuation">.</span>Rescale<span class="token punctuation">(</span>rescale<span class="token punctuation">,</span>shift<span class="token punctuation">)</span>
    hwc2chw_op <span class="token operator">=</span> CV<span class="token punctuation">.</span>HWC2CHW<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># Perform the map operation on the dataset.</span>
    ds <span class="token operator">=</span> ds<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>input_columns<span class="token operator">=</span><span class="token string">"image"</span><span class="token punctuation">,</span> operations<span class="token operator">=</span><span class="token punctuation">[</span>rescale_op<span class="token punctuation">,</span>resize_op<span class="token punctuation">,</span> hwc2chw_op<span class="token punctuation">]</span><span class="token punctuation">)</span>
    ds <span class="token operator">=</span> ds<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>input_columns<span class="token operator">=</span><span class="token string">"label"</span><span class="token punctuation">,</span> operations<span class="token operator">=</span>C<span class="token punctuation">.</span>TypeCast<span class="token punctuation">(</span>ms<span class="token punctuation">.</span>int32<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># Set the shuffle parameter and batch size.</span>
    ds <span class="token operator">=</span> ds<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>buffer_size<span class="token operator">=</span>buffer_size<span class="token punctuation">)</span>
    ds <span class="token operator">=</span> ds<span class="token punctuation">.</span>batch<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> drop_remainder<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ds
</code></pre>
<p>In the preceding information, batch_size indicates the number of data records in each batch. Assume that each batch contains 32 data records. Modify the image size, normalization, and image channel, and then modify the data type of the label. Perform the shuffle operation, set batch_size, and set drop_remainder to True. In this case, data that cannot form a batch in the dataset will be discarded.</p>
<p>MindSpore supports multiple data processing and argumentation operations, which are usually used together. For details, see Data Processing and Data Argumentation.</p>
<h4 id="visualize-samples.">Visualize samples.</h4>
<p>Read the first 10 samples and visualize the samples to determine whether the samples are real datasets.</p>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Display the first 10 images and the labels, and check whether the images are correctly labeled.</span>
ds <span class="token operator">=</span> create_dataset<span class="token punctuation">(</span>training<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> ds<span class="token punctuation">.</span>create_dict_iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__next__<span class="token punctuation">(</span><span class="token punctuation">)</span>
images <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
labels <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>np<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Number: %s'</span> <span class="token operator">%</span> labels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<p>Sample visualization</p>
<h4 id="define-a-network.">Define a network.</h4>
<p>We define a simple fully-connected network to implement image recognition. The network has only three layers:</p>
<ul>
<li>The first layer is a fully-connected layer in the shape of 784 x 512.</li>
<li>The second layer is a fully-connected layer in the shape of 512 x 128.</li>
<li>The last layer is an output layer in the shape of 128 x 10.</li>
</ul>
<p>To use MindSpore for neural network definition, inherit mindspore.nn.cell.Cell. Cell is the base class of all neural networks (such as Conv2d).</p>
<p>Define each layer of a neural network in the <strong>init</strong> method in advance, and then define the construct method to complete the forward construction of the neural network. The network layers are defined as follows:</p>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Create a deep neural network (DNN) model. The model consists of three fully-connected layers. The final output layer uses softmax for classification (10 classes represented by numbers from 0 to 9)</span>
<span class="token keyword">class</span> <span class="token class-name">ForwardNN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Cell<span class="token punctuation">)</span><span class="token punctuation">:</span>      
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ForwardNN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>flatten <span class="token operator">=</span> nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span>  
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
       
    
    <span class="token keyword">def</span> <span class="token function">construct</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>input_x<span class="token punctuation">)</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>output<span class="token punctuation">)</span> 
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>fc3<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        <span class="token keyword">return</span> output  
</code></pre>
<h4 id="define-a-loss-function-and-an-optimizer.">Define a loss function and an optimizer.</h4>
<p>A loss function is also called an objective function and is used to measure the difference between a predicted value and an actual value. Deep learning reduces the loss value by continuous iteration. Defining a good loss function can effectively improve the model performance.</p>
<p>An optimizer is used to minimize the loss function, improving the model during training.</p>
<p>After the loss function is defined, the weight-related gradient of the loss function can be obtained. The gradient is used to indicate the weight optimization direction for the optimizer, improving model performance. Loss functions supported by MindSpore include SoftmaxCrossEntropyWithLogits, L1Loss, and MSELoss.</p>
<p>SoftmaxCrossEntropyWithLogits is used in this example.</p>
<p>MindSpore provides the callback mechanism to execute custom logic during training. The following uses ModelCheckpoint provided by the framework as an example. ModelCheckpoint can save the network model and parameters for subsequent fine-tuning.</p>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Create a network, a loss function, validation metric, and optimizer, and set related hyperparameters.</span>
lr <span class="token operator">=</span> <span class="token number">0.001</span>
num_epoch <span class="token operator">=</span> <span class="token number">10</span>
momentum <span class="token operator">=</span> <span class="token number">0.9</span>

net <span class="token operator">=</span> ForwardNN<span class="token punctuation">(</span><span class="token punctuation">)</span>
loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>loss<span class="token punctuation">.</span>SoftmaxCrossEntropyWithLogits<span class="token punctuation">(</span>sparse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">'mean'</span><span class="token punctuation">)</span>
metrics<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"Accuracy"</span><span class="token punctuation">:</span> Accuracy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
opt <span class="token operator">=</span> nn<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>net<span class="token punctuation">.</span>trainable_params<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token punctuation">)</span> 
Start training<span class="token punctuation">.</span>
The training process refers to a process <span class="token keyword">in</span> which training dataset <span class="token keyword">is</span> transferred to a network <span class="token keyword">for</span> training <span class="token operator">and</span> optimizing network parameters<span class="token punctuation">.</span> In the MindSpore framework<span class="token punctuation">,</span> the <span class="token punctuation">.</span>train method <span class="token keyword">is</span> used to complete this process<span class="token punctuation">.</span>
Code<span class="token punctuation">:</span>
<span class="token comment"># Build a model.</span>
model <span class="token operator">=</span> Model<span class="token punctuation">(</span>net<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> metrics<span class="token punctuation">)</span>
config_ck <span class="token operator">=</span> CheckpointConfig<span class="token punctuation">(</span>save_checkpoint_steps<span class="token operator">=</span><span class="token number">1875</span><span class="token punctuation">,</span> keep_checkpoint_max<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
ckpoint_cb <span class="token operator">=</span> ModelCheckpoint<span class="token punctuation">(</span>prefix<span class="token operator">=</span><span class="token string">"checkpoint_net"</span><span class="token punctuation">,</span>directory <span class="token operator">=</span> <span class="token string">"./ckpt"</span> <span class="token punctuation">,</span>config<span class="token operator">=</span>config_ck<span class="token punctuation">)</span>
<span class="token comment"># Generate a dataset.</span>
ds_eval <span class="token operator">=</span> create_dataset<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>
ds_train <span class="token operator">=</span> create_dataset<span class="token punctuation">(</span>batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>
<span class="token comment"># Train the model.</span>
loss_cb <span class="token operator">=</span> LossMonitor<span class="token punctuation">(</span>per_print_times<span class="token operator">=</span><span class="token number">1875</span><span class="token punctuation">)</span>
time_cb <span class="token operator">=</span> TimeMonitor<span class="token punctuation">(</span>data_size<span class="token operator">=</span>ds_train<span class="token punctuation">.</span>get_dataset_size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"============== Starting Training =============="</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span>train<span class="token punctuation">(</span>num_epoch<span class="token punctuation">,</span> ds_train<span class="token punctuation">,</span>callbacks<span class="token operator">=</span><span class="token punctuation">[</span>ckpoint_cb<span class="token punctuation">,</span>loss_cb<span class="token punctuation">,</span>time_cb <span class="token punctuation">]</span><span class="token punctuation">,</span>dataset_sink_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre>
<p>Loss values are displayed during training, as shown in the following. Although loss values may fluctuate, they gradually decrease and the accuracy gradually increases in general. Loss values displayed each time may be different because of their randomicity. The following is an example of loss values output during training:</p>
<pre><code>============== Starting Training ==============
epoch: 1 step: 1875, loss is 0.06333521
epoch time: 18669.680 ms, per step time: 9.957 ms
epoch: 2 step: 1875, loss is 0.07061358
epoch time: 21463.662 ms, per step time: 11.447 ms
epoch: 3 step: 1875, loss is 0.043515638
epoch time: 25836.919 ms, per step time: 13.780 ms
epoch: 4 step: 1875, loss is 0.03468642
epoch time: 25553.150 ms, per step time: 13.628 ms
epoch: 5 step: 1875, loss is 0.03934026
epoch time: 27364.246 ms, per step time: 14.594 ms
epoch: 6 step: 1875, loss is 0.0023852987
epoch time: 31432.281 ms, per step time: 16.764 ms
epoch: 7 step: 1875, loss is 0.010915326
epoch time: 33697.183 ms, per step time: 17.972 ms
epoch: 8 step: 1875, loss is 0.011417691
epoch time: 29594.438 ms, per step time: 15.784 ms
epoch: 9 step: 1875, loss is 0.00044568744
epoch time: 28676.948 ms, per step time: 15.294 ms
epoch: 10 step: 1875, loss is 0.071476705
epoch time: 34999.863 ms, per step time: 18.667 ms
</code></pre>
<h4 id="validate-the-model.-1">Validate the model.</h4>
<p>In this step, the original test set is used to validate the model.</p>
<p>Code:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Use the test set to validate the model and print the overall accuracy.</span>
metrics<span class="token operator">=</span>model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>ds_eval<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>metrics<span class="token punctuation">)</span>
</code></pre>
<p>Output:</p>
<pre><code>{'Accuracy': 0.9740584935897436}
</code></pre>

    </div>
  </div>
</body>

</html>
